#!/usr/bin/env Rscript

# =============================================================================
# Phylogenetic Tree with Sex and Ancestry Heatmaps
# =============================================================================
# 
# Description: This script creates circular phylogenetic trees with trait 
#              heatmaps showing sex and ancestry information for the hemizygous sex linked region
#
# Prerequisites: 
#   IQ-TREE was run with the following command:
#   iqtree -s commongarden_allsites_193_hap2_hemi.min4.phy -st DNA -T 20 -m TESTONLY
#   (after running vcf2phylip to convert VCF to phylip format)
#
# Author: Julia Kreiner
# Date: May 28th 2025
# =============================================================================

# Load required libraries
library(phytools)
library(ape)
library(adephylo)
library(phylobase)
library(phylotools)
library(phylosignal)
library(viridis)
library(tidytree)
library(ggtree)
library(dplyr)
library(ggstance)
library(data.table)
library(ggnewscale)

# =============================================================================
# DATA IMPORT - Sample Information and Metadata
# =============================================================================

# Import general population list
all <- read.table("data_by_script/05_Phylogenetic/herbcontemp_poplist.txt", na.strings = c("","NA","?"), sep="\t", header = F)
names(all)[1] <- "sample"

# Import PLINK family file
plink <- read.table("data_by_script/05_Phylogenetic/herb_commongarden_pnas_missing9_maf05.fam")
names(plink)[1] <- c("sample")
plink$order <- seq(1, nrow(plink))

# Merge population and PLINK data
both <- inner_join(plink, all, by="sample")

# Import comprehensive sample information
all2 <- read.table("data_by_script/05_Phylogenetic/3waymerged_sampleinfo.txt", sep="\t", header = T)
both2 <- inner_join(plink, all2, by="sample")

# Import PCA eigenvectors from population structure analysis
contemp_herb <- fread("data_by_script/05_Phylogenetic/commongarden_allfiltsnps_193_hap2.eigenvec")
names(contemp_herb)[2] <- "sample"
contemp_herb$sample <- as.character(contemp_herb$sample)
inner_join(contemp_herb, all2, by="sample")

# =============================================================================
# DATASET CLASSIFICATION BY COLLECTION YEAR
# =============================================================================

# Classify samples into datasets based on collection year
all2$dataset <- "PNAS"                        # Default: PNAS dataset
all2$dataset[all2$year == 2019] <- "Paired"   # 2019 collections are "Paired"
all2$dataset[all2$year < 2015] <- "Herbarium" # Pre-2015 are herbarium specimens

# Merge PCA data with sample metadata
contemp_herb_pca <- inner_join(contemp_herb, all2, by="sample")

# Import ancestry metadata (contains ancestry proportions)
meta_ordered <- read.table("data_by_script/05_Phylogenetic/commongarden_and_PNAS_metadata_ancestry.txt", header = T)
names(meta_ordered)[1] <- "sample"
head(contemp_herb_pca)

# Final merge: combine PCA data with ancestry information
contemp_herb_pca_anc <- inner_join(contemp_herb_pca, meta_ordered, by="sample")

# Set tip labels for phylogenetic tree matching
# Using sample names as tip labels for the phylogenetic tree
contemp_herb_pca_anc$tip.label <- contemp_herb_pca_anc$sample

# =============================================================================
# PHYLOGENETIC TREE IMPORT AND PROCESSING
# =============================================================================

# Import phylogenetic tree generated by IQ-TREE
hemi_tree <- read.tree("data_by_script/05_Phylogenetic/commongarden_allsites_193_hap2_hemi.min4.phy.treefile")
hemi_tree$tip.label

# Quick visualization to check tree structure
plot(hemi_tree, cex=.2)

# =============================================================================
# DATA ALIGNMENT - Match metadata to tree tips
# =============================================================================

# Order metadata to match phylogenetic tree tip labels
# This is critical - ensures trait data corresponds to correct tree tips
ordered <- contemp_herb_pca_anc[match(hemi_tree$tip.label, contemp_herb_pca_anc$tip.label),]

# Convert sex to factor for proper visualization
ordered$sex <- as.factor(ordered$sex)

# Create tip states data frame for heatmap visualization
# Extract sex (column 14) and ancestry (column 24) information
tipstates <- ordered[,c(14,24)]
row.names(tipstates) <- ordered$tip.label

# =============================================================================
# PREPARE INDIVIDUAL TRAIT DATA FRAMES FOR HEATMAPS
# =============================================================================

# Create separate data frames for each trait to be visualized
tipstate1 <- data.frame(sex=ordered[,c(14)])        # Sex information
tipstate2 <- data.frame(anc=ordered[,c(24)])        # Ancestry measured based of STRUCTURE at k=2
tipstate3 <- data.frame(anc=ordered[,c(22)])        # Pop Info
tipstate4 <- data.frame(anc=ordered[,c(23)])        # Habitat Info

# Set row names to match tree tip labels for all trait data frames
row.names(tipstate1) <- ordered$tip.label
row.names(tipstate2) <- ordered$tip.label
row.names(tipstate3) <- ordered$tip.label
row.names(tipstate4) <- ordered$tip.label

# =============================================================================
# PHYLOGENETIC TREE VISUALIZATION WITH HEATMAPS
# =============================================================================

# Create base circular phylogenetic tree
p <- ggtree(hemi_tree, layout = "circular", ladderize = T)

# Add first heatmap layer: Sex information
p1 <- gheatmap(p, data = tipstate1, color="black",
               legend_title = "Sex", width = .2, colnames = F,
               colnames_angle=95, colnames_offset_y = .25) +
  scale_fill_viridis_d(option="magma", end = .92, name="Sex Grouping")

# Display sex heatmap
p1

# Add second heatmap layer: Ancestry information
# new_scale_fill() allows multiple fill scales in the same plot
p2 <- p1 + new_scale_fill()
p2.2 <- gheatmap(p2, tipstate2, width=.2, offset = .01, colnames = F,
                 colnames_angle=90, colnames_offset_y = .25) +
  scale_fill_viridis_c(name="var. Rudis Ancestry")

# Display final plot with both sex and ancestry heatmaps
#FIGURE 3A
p2.2

